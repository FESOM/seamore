#!/usr/bin/env ruby

require 'gli'

require_relative "../lib/data_request.rb"
require_relative "../lib/fesom_output_dir.rb"
require_relative "../lib/fesom_possible_var.rb"
require_relative "../lib/matcher.rb"

ENV['GLI_DEBUG']='true' # set environment GLI_DEBUG=true to show the full backtrace

include GLI::App

program_desc 'CMORize FESOM output to a given CMIP6 data request'

subcommand_option_handling :normal
arguments :strict


desc 'Print data request variables for json tables at PATH'
arg "tables_dir"
command :print_request do |c|  
  c.action do |global_opts,opts,args|    
    puts DataRequest.new_from_tables_dir args.first
  end
end


desc 'Print FESOM output variables available at PATH'
arg "FESOM_output_dir"
command :print_available do |c|  
  c.action do |global_opts,opts,args|    
    puts FesomOutputDir.new(args.first)
  end
end


desc 'Print variables FESOM (r550) could possibly produce'
command :print_possible do |c|  
  c.action do |global_opts,opts,args|    
    vars = FesomPossibleVar.create_from_fortran_code(FESOM_VARIABLE_INITIALIZATION_CODE)
    vars.each {|v| puts v}
  end
end


desc 'Print matches of FESOM output variables and a given data request'
arg "tables_dir"
arg "FESOM_output_dir"
command :match_available do |c|  
  c.action do |global_opts,opts,args|    
    puts Matcher.print_matching_available(request_dir: args[0], output_dir: args[1])
  end
end


exit run(ARGV)
